version: 2

unit_tests:
  - name: test__delivery_performance_by_courier
    description: "Ensure correct aggregation of delivery metrics by courier"
    model: delivery_performance_by_courier

    given:
      - input: source('silver','FACT_SHIPMENTS')
        rows:
          - { CARRIER_ID: "C001", CARRIER_NAME: "Delhivery", DELIVERY_TAT_DAYS: 2, DELAY_FLAG: true }
          - { CARRIER_ID: "C001", CARRIER_NAME: "Delhivery", DELIVERY_TAT_DAYS: 3, DELAY_FLAG: false }
          - { CARRIER_ID: "C002", CARRIER_NAME: "BlueDart", DELIVERY_TAT_DAYS: 5, DELAY_FLAG: true }

      - input: ref('dim_couriers')
        rows:
          - { COURIER_ID: "C001", NAME: "Delhivery" }
          - { COURIER_ID: "C002", NAME: "BlueDart" }

    expect:
      rows:
        - { CARRIER_NAME: "Delhivery", total_shipments: 2, avg_delivery_days: 2.5, delay_percentage: 50.0 }
        - { CARRIER_NAME: "BlueDart", total_shipments: 1, avg_delivery_days: 5.0, delay_percentage: 100.0 }
